{"version":3,"file":"js/887.06e6a2ef.js","mappings":"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","sources":["webpack://front/./src/components/Loading.vue","webpack://front/./src/components/Loading.vue?1ccf","webpack://front/./src/views/Book/ChapterView.vue","webpack://front/./src/views/Book/ChapterView.vue?2c6b"],"sourcesContent":["<template>\n    <div class=\"texture-bg absolute top-0 bottom-0 right-0 left-0 z-10\n                flex justify-center items-center\">\n        <div>\n            <img class=\"w-[18.75rem] h-[4.75rem] animate-bounce\" src=\"@/assets/img/logo.png\" alt=\"\">\n            <p v-if=\"text\">{{ text }}</p>\n        </div>\n    </div>\n</template>\n<script>\nexport default {\n    props: {\n        text: {\n            required: false\n        }\n    }\n}\n</script>","import { render } from \"./Loading.vue?vue&type=template&id=262e83e6\"\nimport script from \"./Loading.vue?vue&type=script&lang=js\"\nexport * from \"./Loading.vue?vue&type=script&lang=js\"\n\nimport exportComponent from \"../../node_modules/vue-loader/dist/exportHelper.js\"\nconst __exports__ = /*#__PURE__*/exportComponent(script, [['render',render]])\n\nexport default __exports__","<template>\n    <Loading v-if=\"loading\"/>\n    <div v-else>\n        <p v-if=\"user.type !== 'admin'\" class=\"leading-none text-[1.5rem] mb-10\">{{ chapter?.question }}</p>\n        <div v-else>\n            <button class=\"mb-4\" :disabled=\"canDelete\" @click=\"deleteChapter\">Удалить главу</button>\n            <div class=\"flex\">\n                <input class=\"text-[1.5rem] mb-4 h-[2.9375rem] !rounded-r-none\" type=\"text\" v-model=\"chapter.title\"\n                       placeholder=\"Заголовок...\">\n            </div>\n            <div class=\"flex\">\n                <input class=\"text-[1.5rem] mb-10 h-[2.9375rem] !rounded-r-none\" type=\"text\" v-model=\"chapter.question\"\n                       placeholder=\"Вопрос...\">\n                <button class=\"!rounded-l-none\" @click=\"saveQuestion\">Сохранить</button>\n            </div>\n        </div>\n\n        <p class=\"mb-4\"></p>\n        <textarea\n            class=\"mb-4\"\n            rows=\"8\"\n            placeholder=\"Введите текст...\"\n            v-model=\"chapter.text\"\n            @input=\"updateCursorPosition\"\n            @click=\"updateCursorPosition\"\n            @keyup=\"updateCursorPosition\"\n        ></textarea>\n        <div class=\"flex justify-between mb-8\">\n            <div class=\"flex items-start\">\n                <button class=\"mr-2\" @click=\"saveChapter\">Сохранить</button>\n                <button class=\"mr-2\" @click=\"startUpload\" :disabled=\"cursorPosition === null\">\n                    <Icon class=\"mr-1\" type=\"folder\" color=\"black\"/>\n                    Добавить фото\n                </button>\n                <input id=\"fileInput\" type=\"file\" hidden @input=\"makeInput\">\n            </div>\n        </div>\n\n        <Pagination\n            :page=\"currentPage + offset\"\n            :total_pages=\"totalPages\"\n            @nextPage=\"nextPage\"\n            @prevPage=\"previousPage\"\n            class=\"mb-[2.75rem]\"\n        />\n\n        <Preview :payload=\"previewPayload\"/>\n    </div>\n</template>\n\n<script>\nimport Icon from \"@/components/Icon.vue\";\nimport Preview from \"@/components/Book/Preview.vue\";\nimport {useBookStore} from \"@/stores/book\";\nimport Loading from \"@/components/Loading.vue\";\nimport Pagination from \"@/components/Pagination.vue\";\nimport {useUserStore} from \"@/stores/user\";\nimport {useAdminStore} from \"@/stores/admin\";\nimport {chapterDivider, chapterDividerV2, pageFormatter} from \"@/plugins/helpers\";\n\nexport default {\n    name: \"ChapterView\",\n    components: {Pagination, Loading, Preview, Icon},\n\n    data: () => ({\n        bookStore: useBookStore(),\n        userStore: useUserStore(),\n        adminStore: useAdminStore(),\n\n        chapter: {\n            title: null,\n            question: null,\n            text: null,\n        },\n\n        pages: [],\n        pagesFormatted: [],\n        currentPage: 1,\n        offset: 0,\n        cursorPosition: null,\n\n        image: null,\n\n        loading: false,\n        chapterText: null,\n    }),\n\n    computed: {\n        canDelete() {\n            if (this.chapter.text) {\n                return this.chapter.text.length\n            }\n\n            return false\n        },\n\n        totalPages() {\n            return (this.pages.length > 0 ? this.pages.length : 1) + this.offset\n        },\n\n        user() {\n            return this.userStore.user\n        },\n\n        previewPayload() {\n            let leftPage, rightPage\n            let pageNumber = this.currentPage + this.offset\n            let defaultPage = {\n                title: null,\n                text: null,\n                page: null,\n            }\n\n            if (pageNumber % 2 === 0) {\n                if (this.pagesFormatted[this.currentPage - 2]) {\n                    leftPage = this.pagesFormatted[this.currentPage - 2]\n                } else {\n                    leftPage = defaultPage\n                }\n\n                rightPage = this.pagesFormatted[this.currentPage - 1]\n            } else {\n                if (this.pagesFormatted[this.currentPage]) {\n                    rightPage = this.pagesFormatted[this.currentPage]\n                } else {\n                    rightPage = defaultPage\n                }\n\n\n                leftPage = this.pagesFormatted[this.currentPage - 1]\n            }\n\n            return [leftPage, rightPage]\n        },\n    },\n\n    methods: {\n        startUpload() {\n            document.querySelector('#fileInput').click()\n        },\n\n        async makeInput() {\n            alert('Каждая добавленная фотография займет целую страницу. ' +\n                'В текстовой строке появится \"ссылка\" на фото — она должна находиться в новой строке. ' +\n                'Чтобы удалить фотографию, просто удалите текст \"ссылки\".')\n\n            const input = document.querySelector('#fileInput')\n            const files = input.files\n\n            if (files && files[0]) {\n                const reader = new FileReader()\n\n                // reader.onload = (e) => {\n                //     this.image = e.target.result\n                // }\n\n                reader.readAsDataURL(files[0])\n                this.image = files[0]\n                this.$emit('input', files[0])\n\n                await this.bookStore.addImage(this.chapter.id, this.image).then(url => {\n                    let tmp\n\n                    if (this.cursorPosition !== 0) {\n                        tmp = [this.chapter.text.substring(0, this.cursorPosition), this.chapter.text.substring(this.cursorPosition)]\n                    } else {\n                        tmp = ['', '']\n                    }\n\n                    this.chapter.text = tmp[0] + `\\n<img src=\"${url}\" alt=\"image\"/>\\n` + tmp[1]\n                })\n            }\n        },\n\n        async getChapter() {\n            this.loading = true\n\n            await this.bookStore.getChapter(this.$route.params.id)\n                .then(response => {\n                    this.chapter = response.chapter\n                    this.offset = response.pc_last_page ?? 0\n                    this.currentPage = 1\n                    this.chapterText = response.chapter.text\n                })\n                .finally(() => {\n                    this.loading = false\n                })\n        },\n\n        async saveQuestion() {\n            let chapterId = this.chapter.id\n            let payload = {\n                question: this.chapter.question,\n                title: this.chapter.title\n            }\n\n            this.loading = true\n\n            await this.adminStore.saveChapterQuestion(chapterId, payload)\n        },\n\n        async saveChapter() {\n            this.loading = true\n\n            await this.bookStore.saveChapter(this.chapter.id, this.chapter.text)\n                .finally(() => {\n                    location.reload()\n                    this.loading = false\n                })\n        },\n\n        async deleteChapter() {\n            this.loading = true\n\n            await this.bookStore.deleteChapter(this.chapter.id)\n                .finally(() => {\n                    location.href = '/client/book/cover'\n                    this.loading = false\n                })\n        },\n\n\n        nextPage() {\n            if (this.currentPage !== this.totalPages - this.offset) {\n                this.currentPage++\n            }\n        },\n\n        previousPage() {\n            if (this.currentPage !== 1) {\n                this.currentPage--\n            }\n        },\n\n        canUpdate() {\n            if (this.chapter.text !== this.chapterText) {\n                return confirm('Вы сохранили страницу? Введённые изменения будут утеряны!')\n            }\n\n            return true;\n        },\n\n        updateCursorPosition(e) {\n            let target = e.target\n\n            this.cursorPosition = target.selectionStart\n        }\n    },\n\n    watch: {\n        async $route(to, from) {\n            await this.getChapter()\n        },\n\n        'chapter.text'() {\n            // this.pages = chapterDivider(this.chapter.text)\n            this.pages = chapterDividerV2(this.chapter.text)\n        },\n\n        pages() {\n            this.pagesFormatted = pageFormatter(this.pages, this.chapter.title, this.offset)\n        },\n\n        image() {\n            console.log(this.image)\n        },\n\n        cursorPosition() {\n            let symbols = 0\n            let page = null;\n\n            for (let i in this.pages) {\n                for (let j in this.pages[i]) {\n                    for (let k in this.pages[i][j]) {\n                        if (symbols > this.cursorPosition) {\n                            page = i\n                            break\n                        }\n\n                        symbols += this.pages[i][j][k].length + 1\n                    }\n\n                    if (page !== null) {\n                        break\n                    }\n                }\n\n                if (page !== null) {\n                    break\n                }\n            }\n\n            this.currentPage = +page + 1\n        }\n    },\n\n    async mounted() {\n        await this.getChapter()\n\n        document.addEventListener('keydown', event => {\n            if ((event.ctrlKey || event.metaKey) && event.key === 's') {\n                // Отменяем стандартное поведение (сохранение страницы)\n                event.preventDefault();\n\n                this.saveChapter()\n            }\n        })\n\n        // window.onbeforeunload = event => {\n        //     return this.canUpdate()\n        // };\n    },\n\n    beforeRouteUpdate(to, from, next) {\n        if (this.canUpdate()) {\n            next()\n        } else {\n            next(false)\n        }\n    },\n\n    beforeRouteLeave(to, from, next) {\n        if (this.canUpdate()) {\n            next()\n        } else {\n            next(false)\n        }\n    }\n}\n</script>","import { render } from \"./ChapterView.vue?vue&type=template&id=5534ff42\"\nimport script from \"./ChapterView.vue?vue&type=script&lang=js\"\nexport * from \"./ChapterView.vue?vue&type=script&lang=js\"\n\nimport exportComponent from \"../../../node_modules/vue-loader/dist/exportHelper.js\"\nconst __exports__ = /*#__PURE__*/exportComponent(script, [['render',render]])\n\nexport default __exports__"],"names":["class","src","alt","text","props","required","__exports__","render","loading","user","type","chapter","question","disabled","canDelete","deleteChapter","placeholder","title","saveQuestion","rows","updateCursorPosition","saveChapter","startUpload","cursorPosition","color","id","hidden","makeInput","page","currentPage","offset","total_pages","totalPages","nextPage","previousPage","payload","previewPayload","name","components","Pagination","Loading","Preview","Icon","data","bookStore","userStore","adminStore","pages","pagesFormatted","image","chapterText","computed","this","length","leftPage","rightPage","pageNumber","defaultPage","methods","document","querySelector","click","alert","input","files","reader","FileReader","readAsDataURL","$emit","addImage","then","url","tmp","substring","getChapter","$route","params","response","pc_last_page","finally","chapterId","saveChapterQuestion","location","reload","href","canUpdate","confirm","e","target","selectionStart","watch","to","from","console","log","symbols","i","j","k","mounted","addEventListener","event","ctrlKey","metaKey","key","preventDefault","beforeRouteUpdate","next","beforeRouteLeave"],"sourceRoot":""}