"use strict";(self["webpackChunkfront"]=self["webpackChunkfront"]||[]).push([[326],{6409:function(t,e,a){a.d(e,{A:function(){return p}});var s=a(641),i=a(33),r=a(5549);const o={class:"texture-bg absolute top-0 bottom-0 right-0 left-0 z-10 flex justify-center items-center"},n={key:0};function l(t,e,a,l,u,h){return(0,s.uX)(),(0,s.CE)("div",o,[(0,s.Lk)("div",null,[e[0]||(e[0]=(0,s.Lk)("img",{class:"w-[18.75rem] h-[4.75rem] animate-bounce",src:r,alt:""},null,-1)),a.text?((0,s.uX)(),(0,s.CE)("p",n,(0,i.v_)(a.text),1)):(0,s.Q3)("",!0)])])}var u={props:{text:{required:!1}}},h=a(6262);const c=(0,h.A)(u,[["render",l]]);var p=c},8355:function(t,e,a){a.r(e),a.d(e,{default:function(){return F}});var s=a(641),i=a(33),r=a(3751);const o={key:1},n={key:0,class:"leading-none text-[1.5rem] mb-10"},l={key:1},u={class:"flex"},h={class:"flex"},c={class:"flex justify-between mb-8"},p={class:"flex items-start"},d=["disabled"];function g(t,e,a,g,m,f){const P=(0,s.g2)("Loading"),k=(0,s.g2)("Icon"),b=(0,s.g2)("Pagination"),v=(0,s.g2)("Preview");return t.loading?((0,s.uX)(),(0,s.Wv)(P,{key:0})):((0,s.uX)(),(0,s.CE)("div",o,["admin"!==f.user.type?((0,s.uX)(),(0,s.CE)("p",n,(0,i.v_)(t.chapter?.question),1)):((0,s.uX)(),(0,s.CE)("div",l,[(0,s.Lk)("div",u,[(0,s.bo)((0,s.Lk)("input",{class:"text-[1.5rem] mb-4 h-[2.9375rem] !rounded-r-none",type:"text","onUpdate:modelValue":e[0]||(e[0]=e=>t.chapter.title=e),placeholder:"Заголовок..."},null,512),[[r.Jo,t.chapter.title]])]),(0,s.Lk)("div",h,[(0,s.bo)((0,s.Lk)("input",{class:"text-[1.5rem] mb-10 h-[2.9375rem] !rounded-r-none",type:"text","onUpdate:modelValue":e[1]||(e[1]=e=>t.chapter.question=e),placeholder:"Вопрос..."},null,512),[[r.Jo,t.chapter.question]]),(0,s.Lk)("button",{class:"!rounded-l-none",onClick:e[2]||(e[2]=(...t)=>f.saveQuestion&&f.saveQuestion(...t))},"Сохранить")])])),e[11]||(e[11]=(0,s.Lk)("p",{class:"mb-4"},null,-1)),(0,s.bo)((0,s.Lk)("textarea",{class:"mb-4",rows:"8",placeholder:"Введите текст...","onUpdate:modelValue":e[3]||(e[3]=e=>t.chapter.text=e),onInput:e[4]||(e[4]=(...t)=>f.updateCursorPosition&&f.updateCursorPosition(...t)),onClick:e[5]||(e[5]=(...t)=>f.updateCursorPosition&&f.updateCursorPosition(...t)),onKeyup:e[6]||(e[6]=(...t)=>f.updateCursorPosition&&f.updateCursorPosition(...t))},null,544),[[r.Jo,t.chapter.text]]),(0,s.Lk)("div",c,[(0,s.Lk)("div",p,[(0,s.Lk)("button",{class:"mr-2",onClick:e[7]||(e[7]=(...t)=>f.saveChapter&&f.saveChapter(...t))},"Сохранить"),(0,s.Lk)("button",{class:"mr-2",onClick:e[8]||(e[8]=(...t)=>f.startUpload&&f.startUpload(...t)),disabled:null===t.cursorPosition},[(0,s.bF)(k,{class:"mr-1",type:"folder",color:"black"}),e[10]||(e[10]=(0,s.eW)(" Добавить фото "))],8,d),(0,s.Lk)("input",{id:"fileInput",type:"file",hidden:"",onInput:e[9]||(e[9]=(...t)=>f.makeInput&&f.makeInput(...t))},null,32)])]),(0,s.bF)(b,{page:t.currentPage+t.offset,total_pages:f.totalPages,onNextPage:f.nextPage,onPrevPage:f.previousPage,class:"mb-[2.75rem]"},null,8,["page","total_pages","onNextPage","onPrevPage"]),(0,s.bF)(v,{payload:f.previewPayload},null,8,["payload"])]))}var m=a(1708),f=a(1120),P=a(6506),k=a(6409),b=a(94),v=a(3468),x=a(5800),y=a(4002),C={name:"ChapterView",components:{Pagination:b.A,Loading:k.A,Preview:f.A,Icon:m.A},data:()=>({bookStore:(0,P._)(),userStore:(0,v.k)(),adminStore:(0,x.g)(),chapter:{title:null,question:null,text:null},pages:[],pagesFormatted:[],currentPage:1,offset:0,cursorPosition:null,image:null,loading:!1,chapterText:null}),computed:{totalPages(){return(this.pages.length>0?this.pages.length:1)+this.offset},user(){return this.userStore.user},previewPayload(){let t,e,a=this.currentPage+this.offset,s={title:null,text:null,page:null};return a%2===0?(t=this.pagesFormatted[this.currentPage-2]?this.pagesFormatted[this.currentPage-2]:s,e=this.pagesFormatted[this.currentPage-1]):(e=this.pagesFormatted[this.currentPage]?this.pagesFormatted[this.currentPage]:s,t=this.pagesFormatted[this.currentPage-1]),[t,e]}},methods:{startUpload(){document.querySelector("#fileInput").click()},async makeInput(){alert('Каждая добавленная фотография займет целую страницу. В текстовой строке появится "ссылка" на фото — она должна находиться в новой строке. Чтобы удалить фотографию, просто удалите текст "ссылки".');const t=document.querySelector("#fileInput"),e=t.files;if(e&&e[0]){const t=new FileReader;t.readAsDataURL(e[0]),this.image=e[0],this.$emit("input",e[0]),await this.bookStore.addImage(this.chapter.id,this.image).then((t=>{let e;e=0!==this.cursorPosition?[this.chapter.text.substring(0,this.cursorPosition),this.chapter.text.substring(this.cursorPosition)]:["",""],this.chapter.text=e[0]+`<img src="${t}" alt="image"/>`+e[1]}))}},async getChapter(){this.loading=!0,await this.bookStore.getChapter(this.$route.params.id).then((t=>{this.chapter=t.chapter,this.offset=t.pc_last_page??0,this.currentPage=1,this.chapterText=t.chapter.text})).finally((()=>{this.loading=!1}))},async saveQuestion(){let t=this.chapter.id,e={question:this.chapter.question,title:this.chapter.title};this.loading=!0,await this.adminStore.saveChapterQuestion(t,e)},async saveChapter(){this.loading=!0,await this.bookStore.saveChapter(this.chapter.id,this.chapter.text).finally((()=>{location.reload(),this.loading=!1}))},nextPage(){this.currentPage!==this.totalPages-this.offset&&this.currentPage++},previousPage(){1!==this.currentPage&&this.currentPage--},canUpdate(){return this.chapter.text===this.chapterText||confirm("Вы сохранили страницу? Введённые изменения будут утеряны!")},updateCursorPosition(t){let e=t.target;this.cursorPosition=e.selectionStart}},watch:{async $route(t,e){await this.getChapter()},"chapter.text"(){this.pages=(0,y.xt)(this.chapter.text)},pages(){this.pagesFormatted=(0,y.W)(this.pages,this.chapter.title,this.offset)},image(){console.log(this.image)},cursorPosition(){let t=0,e=null;for(let a in this.pages){for(let s in this.pages[a]){for(let i in this.pages[a][s]){if(t>this.cursorPosition){e=a;break}t+=this.pages[a][s][i].length+1}if(null!==e)break}if(null!==e)break}this.currentPage=+e+1}},async mounted(){await this.getChapter(),document.addEventListener("keydown",(t=>{(t.ctrlKey||t.metaKey)&&"s"===t.key&&(t.preventDefault(),this.saveChapter())}))},beforeRouteUpdate(t,e,a){this.canUpdate()?a():a(!1)},beforeRouteLeave(t,e,a){this.canUpdate()?a():a(!1)}},w=a(6262);const L=(0,w.A)(C,[["render",g]]);var F=L},5549:function(t,e,a){t.exports=a.p+"img/logo.47a759af.png"}}]);
//# sourceMappingURL=326.f4ab06c3.js.map